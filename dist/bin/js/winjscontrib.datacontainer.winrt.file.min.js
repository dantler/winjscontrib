/* 
 * WinJS Contrib v2.1.0.7
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

var __global=this,WinJSContrib;!function(n){var t;!function(t){function r(n){return encodeURIComponent(n)+".json"}function e(n,t,e){return n.getItemAsync(r(t)).then(function(n){return n},function(){}).then(function(n){return n?n.deleteAsync().then(function(){e&&e.debug("item deleted "+n.path)},function(t){e&&e.error("cannot delete item "+n.path)}):WinJS.Promise.wrap([])})}function i(n,t){return Windows.Storage.FileIO.readBufferAsync(n).then(function(n){if(!t)return n;if(n.length){var r=new Windows.Security.Cryptography.DataProtection.DataProtectionProvider;return r.unprotectAsync(n)}return null}).then(function(n){var t=null;if(null!==n&&void 0!==n){var r=Windows.Security.Cryptography.CryptographicBuffer.convertBinaryToString(Windows.Security.Cryptography.BinaryStringEncoding.utf8,n);if(r)try{t=JSON.parse(r)}catch(e){}}return t})}function o(n,t,e,a,s,u){return u=u||c,new WinJS.Promise(function(c,h){s=s||0,a=a||Windows.Storage.CreationCollisionOption.openIfExists;var l=r(t);n.getFileAsync(l).then(function(n){return i(n,e)}).then(function(e){u.verbose("read "+n.path+"\\"+r(t)),c(e)},function(i){return-2147024894==i.number?(u.debug("read empty "+n.path+"\\"+r(t)),void c()):(u.warn("error reading "+n.path+"\\"+r(t)),void(2>s?setImmediate(function(){u.info("retry reading "+n.path+"\\"+r(t)),o(n,t,e,a,s+1,u).then(c,h)}):h({message:"fatal error reading "+n.path+"\\"+r(t),exception:i})))})})}function a(n,t,e,i,o,s,u){return u=u||c,new WinJS.Promise(function(c,h){function l(l){u.warn("error writing "+n.path+"\\"+r(t)),2>s?setImmediate(function(){u.info("retry writing "+n.path+"\\"+r(t)),a(n,t,e,i,o,s+1,u).then(c,h)}):h({message:"fatal error writing "+n.path+"\\"+r(t)+"\r\n",exception:l})}s=s||0,o=o||Windows.Storage.CreationCollisionOption.replaceExisting;var f=Windows.Security.Cryptography.CryptographicBuffer.convertStringToBinary(JSON.stringify(e),Windows.Security.Cryptography.BinaryStringEncoding.utf8);if(i)var p=new Windows.Security.Cryptography.DataProtection.DataProtectionProvider("Local=user");var d=n.createFileAsync(r(t),o),g=i?p.protectAsync(f):WinJS.Promise.wrap(f);WinJS.Promise.join([d,g]).then(function(n){var t=n[0],r=n[1];Windows.Storage.FileIO.writeBufferAsync(t,r).then(function(){u.verbose("file written "+t.path),c(t)},l)},l)})}t.current=n.DataContainer.current||null;var c=n.Logs.getLogger("WinJSContrib.DataContainer.WinRT"),s=function(){function t(n,t,r){var e=this;if(e.key=n,e.options=t||{},e.parent=r,e.folderPromise,e.useDataCache=e.options.useDataCache||!1,e.dataCache={},e.childs={},!__global.Windows)throw"WinRT is required !";n?r&&(e.folderPromise=r.folderPromise.then(function(t){return e.options.logger&&e.options.logger.debug("open folder "+n),t.createFolderAsync(n,Windows.Storage.CreationCollisionOption.openIfExists)}).then(function(n){return e.folder=n,n})):(e.folder=Windows.Storage.ApplicationData.current.localFolder,e.folderPromise=WinJS.Promise.wrap(e.folder))}return t.makeCurrent=function(r,e){n.DataContainer.current=new t(r,e)},t.prototype.read=function(n){var t=this;if(t.useDataCache){var r=t.dataCache[n];if(r){var e=JSON.parse(JSON.stringify(r));return WinJS.Promise.wrap(e)}}return t.folderPromise.then(function(r){return o(r,n,t.options.encrypted,Windows.Storage.CreationCollisionOption.openIfExists,0,t.options.logger).then(function(r){return t.useDataCache&&(t.dataCache[n]=r),r})})},t.prototype.save=function(n,t){var r=this;return r.useDataCache&&(r.dataCache[n]=t),r.folderPromise.then(function(e){return a(e,n,t,r.options.encrypted,Windows.Storage.CreationCollisionOption.replaceExisting,0,r.options.logger)})},t.prototype.remove=function(n){var t=this;return t.folderPromise.then(function(r){return e(r,n,t.options.logger)})},t.prototype.listKeys=function(){var n=this;return n.folderPromise.then(function(n){return n.getFilesAsync().then(function(t){return t.map(function(t){var r=t.path.substr(n.path.length+1),e=r.indexOf(".json");return e>0&&(r=r.substr(0,e)),r})})})},t.prototype.list=function(){var n=this;return n.folderPromise.then(function(n){return n.getFilesAsync()})},t.prototype.child=function(n){if(this.childs[n])return this.childs[n];var r=new t(n,this.options,this);return this.childs[n]=r,r},t.prototype.childWithTransaction=function(n,t){var r=this;return this.child(n+"-tmp").folderPromise.then(function(t){return t.deleteAsync().then(function(){return r.child(n+"-tmp")})}).then(function(e){return t(e).then(function(t){return e.folderPromise.then(function(t){return t.renameAsync(n,Windows.Storage.NameCollisionOption.replaceExisting).then(function(){return r.childs[n]=null,r.childs[n+"-tmp"]=null,r.child(n)})})})})},t.prototype.deleteContainer=function(){var n=this;return n.folderPromise.then(function(n){return n.deleteAsync()})},t.prototype.clearAllCache=function(){var n=this;n.clearCache(),n.clearDataCache()},t.prototype.clearCache=function(){var n=this;n.childs={};for(var t in n.childs)n.childs.hasOwnProperty(t)&&n.childs[t].clearCache()},t.prototype.clearDataCache=function(){var n=this;n.dataCache={};for(var t in n.childs)n.childs.hasOwnProperty(t)&&n.childs[t].clearDataCache()},t}();t.WinRTFilesContainer=s}(t=n.DataContainer||(n.DataContainer={}))}(WinJSContrib||(WinJSContrib={}));