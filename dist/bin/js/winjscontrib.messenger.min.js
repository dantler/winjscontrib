/* 
 * WinJS Contrib v2.1.0.7
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

var __global=this,WinJSContrib;!function(WinJSContrib){var MessengerClass=function(){function MessengerClass(e,n){var r=this;r.isWorker=void 0===e.document,r._pendings={},r._receiver=e,r._sender=n||e,r._bindedProcessEvent=r._processEvent.bind(r),r._receiver&&r._receiver.addEventListener("message",r._bindedProcessEvent)}return MessengerClass.prototype._send=function(e){this.isWorker?this._sender.postMessage(JSON.stringify(e)):this._sender.postMessage(JSON.stringify(e),this.domain||"*")},MessengerClass.prototype.importScripts=function(e){return this._receiver?this.start("_doImportScripts",e):WinJS.Promise.wrap()},MessengerClass.prototype._doImportScripts=function(e){return new WinJS.Promise(function(n){if("string"==typeof e)importScripts(e);else if(e.length)for(var r=0;r<e.length;r++)importScripts(e[r]);n()})},MessengerClass.prototype.execute=function(e){var n=this,r=[];if(arguments.length>1)for(var s=1;s<arguments.length;s++)r.push(arguments[s]);if(n._receiver){var i="var messengerFunction="+e;return this.start("_runFunction",{f:i,args:r})}return WinJS.Promise.timeout(0).then(function(){return e.apply(null,r)})},MessengerClass.prototype._runFunction=function(functionArgs){var messenger=this;return new WinJS.Promise(function(c,e){try{eval(functionArgs.f);var res=messengerFunction.apply(null,functionArgs.args);c(res)}catch(exception){e(exception)}})},MessengerClass.prototype.map=function(e,n){var r=this;n.forEach(function(n){r[n]=function(){var r=e[n];return r.apply(e,arguments)}})},MessengerClass.prototype.start=function(e,n,r){var s=this;if(!s._receiver)return WinJS.Promise.wrapError("worker not supported");var i={id:WinJSContrib.Utils.guid(),complete:null,error:null,progress:null,promise:null},t={name:e,id:i.id,messengerId:s.messengerId,type:"run",data:n,asArgs:r,sender:"WinJSContrib.WinJSContrib.Messenger"};i.promise=new WinJS.Promise(function(e,n,r){i.complete=e,i.error=n,i.progress=r},function(){console.warn("message canceled"),t.type="cancel",s._send(t)}),s._pendings[i.id]=i;var o=function(){delete s._pendings[i.id]};return i.promise.done(o,o),s._send(t),i.promise},MessengerClass.prototype._processEvent=function(e){var n=this,r="string"==typeof e.data?JSON.parse(e.data):e.data,s=r.name,i=r.data,t=r.asArgs;if(r.messengerId==n.messengerId)if(r.id){var o=n._pendings[r.id];if(o&&o[r.type])return void o[r.type](i);if("cancel"===r.type){var a=n._pendings[r.id];a&&(a.promise.cancel(),delete n._pendings[r.id])}else{if("run"===r.type&&s&&n[s]){try{var d=null;d=WinJS.Promise.as(t?n[s].apply(n[s],i):n[s](i)),n._pendings[r.id]={promise:d,details:r},d.then(function(e){n._send({name:s,id:r.id,messengerId:n.messengerId,type:"complete",sender:"WinJSContrib.WinJSContrib.Messenger",data:e})},function(e){n._send({name:s,id:r.id,messengerId:n.messengerId,type:"error",sender:"WinJSContrib.WinJSContrib.Messenger",data:e})},function(e){n._send({name:s,id:r.id,messengerId:n.messengerId,type:"progress",sender:"WinJSContrib.WinJSContrib.Messenger",data:e})}).then(function(){delete n._pendings[r.id]})}catch(g){delete n._pendings[r.id],n._send({name:s,id:r.id,messengerId:n.messengerId,type:"error",sender:"WinJSContrib.WinJSContrib.Messenger",data:{description:g.description,message:g.message,stack:g.stack}})}return}"run"===r.type&&n._send({name:s,id:r.id,messengerId:n.messengerId,type:"error",sender:"WinJSContrib.WinJSContrib.Messenger",data:{message:"callback function not found"}})}}else{if(s&&n[s])return void n[s](i);n.dispatchEvent(s,i)}},MessengerClass.prototype.dispose=function(){var e=this;e._receiver&&(e._receiver.terminate&&e._receiver.terminate(),e._receiver.removeEventListener("message",e._bindedProcessEvent))},MessengerClass.SmartWorkerPath="/scripts/winjscontrib/winjscontrib.messenger.worker.js",MessengerClass}();WinJSContrib.MessengerClass=MessengerClass,WinJSContrib.Messenger=WinJS.Class.mix(MessengerClass,WinJS.Utilities.eventMixin),WinJSContrib.SmartWorker=function(e){if(__global&&__global.Worker){var n=new __global.Worker(e||WinJSContrib.Messenger.SmartWorkerPath);return new WinJSContrib.Messenger(n,n)}return new WinJSContrib.Messenger(null,null)};var m=WinJSContrib.Messenger;m.SmartWorker=function(e){return console.warn("WinJSContrib.Messenger.SmartWorker is deprecated, use WinJSContrib.SmartWorker instead"),WinJSContrib.SmartWorker(e)}}(WinJSContrib||(WinJSContrib={}));