/* 
 * WinJS Contrib v2.1.0.7
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

!function(){"use strict";var t=WinJS.Class.mix(WinJS.Class.define(function(){this._initObservable()},{}),WinJS.Binding.mixin,WinJS.Binding.expandProperties({isValid:!1,updated:!1}));WinJS.Namespace.define("WinJSContrib.UI",{DataForm:WinJS.Class.mix(WinJS.Class.define(function(e,i){var n=this;this.element=e||document.createElement("FORM"),i=i||{},this.groups=i.groups,this.messages=i.messages,this.rules=i.rules,this.state=new t,this.state.item={},this.allowTooltip=i.allowTooltip||!0,this.workOnCopy=i.workOnCopy||!0,this.tooltipDelay=i.tooltipDelay||4e3,this.tooltipPosition=i.tooltipPosition||"right",this.tooltipTheme=i.tooltipTheme||"tooltipster-error",this.initValidator(),this.element.winControl=this,this.element.mcnDataForm=!0,this.element.classList.add("win-disposable"),WinJSContrib.CrossPlatform&&WinJSContrib.CrossPlatform.crossPlatformClass&&WinJSContrib.CrossPlatform.crossPlatformClass(this.element),WinJS.UI.setOptions(this,i),WinJS.UI.processAll(this.element).done(function(){WinJS.Binding.processAll(n.element,n.state)}),$(".mcn-dataform-cancel",this.element).click(function(t){t.preventDefault(),n.cancel()})},{messages:{get:function(){return this._messages},set:function(t){this._messages=t}},rules:{get:function(){return this._rules},set:function(t){this._rules=t}},groups:{get:function(){return this._groups},set:function(t){this._groups=t}},item:{get:function(){return this.state.item},set:function(t){var e=this;e.workOnCopy?(e.state.item=$.extend(!0,{},t),e.state.refItem=t):e.state.item=t,e.validator.resetForm(),e.autobindFields(),WinJS.Binding.processAll(this.element,this.state).done(function(){var t=e.allowTooltip;e.allowTooltip=!1,e.validator.form(),e.allowTooltip=t,e.checkState(),e.initValidator(),e.state.updated=!1}),e.dispatchEvent("itemchanged",{dataform:this,item:t})}},updated:{get:function(){return this.state.updated},set:function(t){this.state.updated=t,this.dispatchEvent("haschanges")}},autobindFields:function(){var t=this;$("[data-formfield]",t.element).each(function(){var e=this,i=$(e).data("formfield"),n="value";"checkbox"==e.type&&(n="checked"),WinJSContrib.UI.DataFormBinding(t.state.item,i.split("."),e,[n])})},checkState:function(){var t=this.validator.numberOfInvalids();this.state.isValid=0==t},cancel:function(){var t=this;t.workOnCopy&&(t.item=$.extend(!0,{},t.state.refItem))},save:function(){var t=this;t.workOnCopy&&(t.state.updated=!1,t.state.refItem=$.extend(!0,{},t.state.item))},initValidator:function(){var t=this;this.validator=$(this.element).validate({groups:this.groups,rules:this.rules,submitHandler:function(e){t.dispatchEvent("submitted",{item:t.state.item})},invalidHandler:function(e,i){t.checkState()},errorPlacement:function(e,i){if(t.checkState(),t.allowTooltip){var n=$(i);n.tooltipster({trigger:"custom",onlyOne:!1,position:t.tooltipPosition,theme:t.tooltipTheme});var o=n.data("lastError"),r=$(e).text();n.data("lastError",r),""!==r&&r!==o&&(n.tooltipster("content",r),n.tooltipster("show"),n[0].tooltipsterValidationTimeout=setTimeout(function(){n[0].tooltipsterValidationTimeout=null,n.hasClass("tooltipster")&&n.tooltipster("hide")},t.tooltipDelay))}},success:function(e,i){t.checkState();var n=$(i);n[0].tooltipsterValidationTimeout&&(clearTimeout(n[0].tooltipsterValidationTimeout),n[0].tooltipsterValidationTimeout=null),n.hasClass("tooltipstered")&&n.tooltipster("hide")}})},validate:function(){var t=this.validator.form();return t},dispose:function(){WinJS.Utilities.disposeSubTree(this.element)}},{DefaultBindingOptions:{trimText:!0,convertEmptyToNull:!0},Converters:{none:{fromObject:function(t,e){return t.toString()},fromInput:function(t,e){return t}},text:{fromObject:function(t,e){if("undefined"==typeof t||null===t)return"";var i=t.toString();return i},fromInput:function(t,e){var i=t;return i&&e&&e.trimText&&(i=i.trim()),e&&e.convertEmptyToNull&&(i=""===i?null:i),i}},number:{fromObject:function(t,e){return"number"!=typeof t?"":t.toString()},fromInput:function(t,e){return"undefined"!=typeof t&&null!==t?parseFloat(t.toString().replace(",",".").replace(" ","")):null}},"boolean":{fromObject:function(t,e){return"undefined"==typeof t||null===t?"":t.toString()},fromInput:function(t,e){return"true"===t?!0:"false"===t?!1:null}},object:{fromObject:function(t,e){return t},fromInput:function(t,e){return t}},stringifiedObject:{fromObject:function(t,e){return JSON.stringify(t)},fromInput:function(t,e){return JSON.parse(t)}}}}),WinJS.UI.DOMEventMixin,WinJS.Utilities.createEventProperties("itemchanged","haschanges","submitted")),parentDataForm:function(t){for(var e=t.parentNode;e;){if(e.mcnDataForm)return e.winControl;e=e.parentNode}},DataFormBinding:WinJS.Binding.initializer(function(t,e,i,n){function o(){var o=WinJSContrib.Utils.readProperty(t,e);if("undefined"==typeof o&&(o=null),"INPUT"==i.nodeName&&"radio"==i.type){{i.name}i.value==o&&(i.checked=!0)}else o=f.fromObject(o,l),WinJSContrib.Utils.writeProperty(i,n,o)}function r(){if(s.checkState(),!i.id||s.validator.element(i)){var o=null;if("INPUT"==i.nodeName&&"radio"==i.type){var r=i.name;if(i.form&&i.form[r]&&i.form[r].length)for(var a=0,u=i.form[r].length;u>a;a++){var d=i.form[r][a];if(d.checked){o=d.value;break}}}else o=WinJSContrib.Utils.getProperty(i,n).propValue;void 0!==o&&(o=f.fromInput(o,l)),WinJSContrib.Utils.writeProperty(t,e,o)}s.updated=!0}function a(){c&&s.validator.element(i)}var s=WinJSContrib.UI.parentDataForm(i),l=WinJSContrib.UI.DataForm.DefaultBindingOptions,u=i.getAttribute("data-formfield-options");u&&(l=WinJS.UI.optionsParser(u,window));var d="",m=i.getAttribute("data-forminput");m&&(d=m);var c=!1;i.classList.add("mcn-dataform-field"),i.form||(i.form=s.element);var d="text";$(i).data("formfield-type")?d=$(i).data("formfield-type"):"TEXTAREA"!==i.nodeName&&"undefined"!=typeof i.type&&(d=i.type);var f=WinJSContrib.UI.DataForm.Converters[d]||WinJSContrib.UI.DataForm.Converters.text;i.binded||(i.binded=!0),i.winControl||(i.classList.add("win-disposable"),i.winControl={dispose:function(){i.removeEventListener("change",i.winControl.updateObjectFromInput),i.removeEventListener("blur",i.winControl.validateObjectOnBlur),d&&i.removeEventListener(d,i.winControl.updateObjectFromInput)}}),i.winControl.updateObjectFromInput=r,i.winControl.validateObjectOnBlur=a,d&&i.addEventListener(d,i.winControl.updateObjectFromInput),i.addEventListener("change",i.winControl.updateObjectFromInput),i.id&&i.addEventListener("blur",a);var p={};return p[e]=o,WinJS.Binding.bind(t,p)})})}();