/* 
 * WinJS Contrib v2.1.0.7
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

!function(){var e=WinJSContrib.Logs.getLogger("WinJSContrib.WinRT.MultipleViews"),i=Windows.UI.ViewManagement,n="WinJSContribViewHelper_",t={queryProxyReadyForRelease:n+"queryProxyReadyForRelease",proxyReadyForRelease:n+"proxyReadyForRelease",proxyReleased:n+"proxyReleased",initialize:n+"initialize",navigateTo:n+"navigateTo"};WinJS.Namespace.define("WinJSContrib.WinRT.MultipleViews",{thisDomain:document.location.protocol+"//"+document.location.host,ViewManager:WinJS.Class.mix(WinJS.Class.define(function(e){this._viewReleasedWrapper=this._viewReleased.bind(this),this.pagewrapper=e,window.addEventListener("message",this._handleMessage.bind(this),!1),i.ApplicationView.getForCurrentView().addEventListener("consolidated",this._handleConsolidated.bind(this),!1)},{_handleMessage:function(i){if(e.verbose("handle message",i),i.origin===WinJSContrib.WinRT.MultipleViews.thisDomain&&i.data.type){var n=this.findViewIndexByViewId(i.data.viewId);null!==n&&this.secondaryViews.getItem(n).data._handleMessage(i),this.dispatchEvent(i.data.type,i.data)}},broadcast:function(i,n){e.verbose("broadcast "+i,n);for(var t=0,s=this.secondaryViews.length;s>t;t++){var a=this.secondaryViews.getItem(t).data;a.send(i,n)}},_handleConsolidated:function(e){this.closeAll()},_viewReleased:function(i){e.verbose("view released : "+i.target.viewId),i.target.removeEventListener("released",this._viewReleasedWrapper,!1);var n=this.findViewIndexByViewId(i.target.viewId);null!==n&&this.secondaryViews.splice(n,1)},secondaryViews:new WinJS.Binding.List([]),closeAll:function(){e.verbose("close all views");for(var i=0,n=this.secondaryViews.length;n>i;i++){var t=this.secondaryViews.getItem(i).data;t.close()}},findViewIndexByViewId:function(e){for(var i=0,n=this.secondaryViews.length;n>i;i++){var t=this.secondaryViews.getItem(i).data;if(e===t.viewId)return i}return null},findViewByViewId:function(e){for(var i=0,n=this.secondaryViews.length;n>i;i++){var t=this.secondaryViews.getItem(i).data;if(e===t.viewId)return t}return null},findViewByTitle:function(e){for(var i=0,n=this.secondaryViews.length;n>i;i++){var t=this.secondaryViews.getItem(i).data;if(e===t.title)return t}return null},openViewFor:function(i,n,t,s,a){var o=this.findViewByTitle(i);if(!o)return this.openView(n,t,s,a).then(function(e){e.view.title=i});o.navigateTo(n,t,!0);var r=s||Windows.UI.ViewManagement.ViewSizePreference["default"],d=a||Windows.UI.ViewManagement.ViewSizePreference["default"];return o.startViewInUse(),new WinJS.Promise(function(i,n){Windows.UI.ViewManagement.ApplicationViewSwitcher.tryShowAsStandaloneAsync(o.viewId,d,Windows.UI.ViewManagement.ApplicationView.getForCurrentView().id,r).done(function(e){o.stopViewInUse(),i({view:o,pointer:e})},function(i){e.error(i),n(i)})})},openView:function(i,n,t,s){var a=this.createNewView(i,n),o=t||Windows.UI.ViewManagement.ViewSizePreference["default"],r=s||Windows.UI.ViewManagement.ViewSizePreference["default"];return a.startViewInUse(),new WinJS.Promise(function(t,s){Windows.UI.ViewManagement.ApplicationViewSwitcher.tryShowAsStandaloneAsync(a.viewId,r,Windows.UI.ViewManagement.ApplicationView.getForCurrentView().id,o).done(function(e){a.initialize(i,n),a.stopViewInUse(),t({view:a,pointer:e})},function(i){e.error(i),s(i)})})},projectViewFor:function(i,n,t){if(!Windows.UI.ViewManagement.ProjectionManager.projectionDisplayAvailable)return this.openViewFor(i,n,t);var s=this.findViewByTitle(i);return s?(s.navigateTo(n,t,!0),s.startViewInUse(),new WinJS.Promise(function(i,n){Windows.UI.ViewManagement.ProjectionManager.startProjectingAsync(s.viewId,Windows.UI.ViewManagement.ApplicationView.getForCurrentView().id).done(function(e){s.stopViewInUse(),i({view:s,pointer:e})},function(i){e.error(i),n(i)})})):this.projectView(n,t).then(function(e){e.view.title=i})},projectView:function(i,n){if(!Windows.UI.ViewManagement.ProjectionManager.projectionDisplayAvailable)return this.openView(i,n);var t=this.createNewView(i,n);return t.startViewInUse(),new WinJS.Promise(function(s,a){Windows.UI.ViewManagement.ProjectionManager.startProjectingAsync(t.viewId,Windows.UI.ViewManagement.ApplicationView.getForCurrentView().id).done(function(e){t.initialize(i,n),t.stopViewInUse(),s({view:t,pointer:e})},function(i){e.error(i),a(i)})})},createNewView:function(){e.verbose("create view");var i=MSApp.createNewView(this.pagewrapper),n=new WinJSContrib.WinRT.MultipleViews.ViewLifetimeControlProxy(i);return n.addEventListener("released",this._viewReleasedWrapper,!1),this.secondaryViews.push(n),n}}),WinJS.Utilities.eventMixin,WinJS.Binding.observableMixin),ViewLifetimeControlProxy:WinJS.Class.mix(WinJS.Class.define(function(e){this.appView=e,this.viewId=e.viewId,this.title="",this.initialized=!1},{_refCount:0,initialize:function(i,n){this.initialized||(e.verbose("proxy initialize view"),this.initialized=!0,this.send(t.initialize,{location:{uri:i,state:n}}))},send:function(i,n){if(e.verbose("proxy sending message "+i,n),!i)throw"Must specify a type of message to send to the proxy";n=n||{},n.type=i,this.appView.postMessage(n,WinJSContrib.WinRT.MultipleViews.thisDomain)},navigateTo:function(e,i,n){var t=JSON.parse(JSON.stringify(i));n&&(t.clearNavigationHistory=!0),this.send("navigateTo",{location:{uri:e,state:t}})},_handleMessage:function(i){var n=i.data;switch(e.verbose("proxy received message "+n.type),n.type){case t.queryProxyReadyForRelease:0===this._refCount&&(this.dispatchEvent("released"),this.send(t.proxyReleased));break;default:this.dispatchEvent(n.type,n)}},appView:null,startViewInUse:function(){this._refCount++},stopViewInUse:function(){this._refCount--,0===this._refCount&&this.send(t.proxyReadyForRelease)},openAsync:function(i,n){e.verbose("proxy open view");var t=this,s=i||Windows.UI.ViewManagement.ViewSizePreference["default"],a=n||Windows.UI.ViewManagement.ViewSizePreference["default"];return t.startViewInUse(),new WinJS.Promise(function(e,i){Windows.UI.ViewManagement.ApplicationViewSwitcher.tryShowAsStandaloneAsync(t.viewId,a,Windows.UI.ViewManagement.ApplicationView.getForCurrentView().id,s).done(function(i){t.stopViewInUse(),e({view:t,pointer:i})},i)})},close:function(){var n=this;e.verbose("proxy close view"),n.startViewInUse();var t=function(){n.stopViewInUse()};return i.ApplicationViewSwitcher.switchAsync(i.ApplicationView.getForCurrentView().id,n.viewId,i.ApplicationViewSwitchingOptions.consolidateViews).then(t,t)}}),WinJS.Utilities.eventMixin,WinJS.Binding.observableMixin),ViewLifetimeControl:WinJS.Class.mix(WinJS.Class.define(function(){this.opener=MSApp.getViewOpener(),this._handleMessageWrapper=this._handleMessage.bind(this),this._onConsolidatedWrapper=this._onConsolidated.bind(this),this._onVisibilityChangeWrapper=this._onVisibilityChange.bind(this),this._finalizeReleaseWrapper=this._finalizeRelease.bind(this),this.viewId=i.ApplicationView.getForCurrentView().id},{_refCount:0,_proxyReleased:!1,_consolidated:!0,send:function(i,n){if(e.verbose("sending message "+i,n),!i)throw"Must specify a type of message to send to the proxy";n=n||{},n.type=i,n.viewId=this.viewId,this.opener.postMessage(n,WinJSContrib.WinRT.MultipleViews.thisDomain)},_handleMessage:function(i){if(e.verbose("received message "+i.origin+"-"+(i.data?i.data.type:"")),i.origin===WinJSContrib.WinRT.MultipleViews.thisDomain&&i.data.type){var n=i.data;switch(n.type){case t.proxyReleased:this._proxyReleased=!0,setImmediate(this._finalizeReleaseWrapper);break;case t.proxyReadyForRelease:0===this._refCount&&this.send(t.queryProxyReadyForRelease);break;case t.initialize:this.dispatchEvent("initialize",i.data);break;default:this.dispatchEvent(n.type,n)}}},_onConsolidated:function(){this._setConsolidated(!0)},_onVisibilityChange:function(){document.hidden||this._setConsolidated(!1)},_setConsolidated:function(e){this._consolidated!==e&&(this._consolidated=e,e?this.stopViewInUse():this.startViewInUse())},_finalizeRelease:function(n){e.verbose("close window"),(0===this._refCount||n)&&(window.removeEventListener("message",this._handleMessageWrapper,!1),i.ApplicationView.getForCurrentView().removeEventListener("consolidated",this._onConsolidatedWrapper,!1),document.removeEventListener("visibilitychange",this._onVisibilityChangeWrapper,!1),this.dispatchEvent("released"),window.close())},initialize:function(){e.verbose("initialize window"),window.addEventListener("message",this._handleMessageWrapper,!1),i.ApplicationView.getForCurrentView().addEventListener("consolidated",this._onConsolidatedWrapper,!1),document.addEventListener("visibilitychange",this._onVisibilityChangeWrapper,!1)},startViewInUse:function(){this._refCount++},close:function(){this.stopViewInUse()},stopViewInUse:function(){this._refCount--,0===this._refCount&&(this._proxyReleased?setImmediate(this._finalizeReleaseWrapper):this.send(t.queryProxyReadyForRelease))}}),WinJS.Utilities.eventMixin)})}();